{"ast":null,"code":"import _regeneratorRuntime from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import\"antd-mobile/lib/toast/style\";import _Toast from\"antd-mobile/lib/toast\";import _asyncToGenerator from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/wlp6897/newProjects/cordovaProjects/installment/front-end/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React from'react';import{HashRouter as Router,Route}from'react-router-dom';import Routers from'@/plugins/libs/routerMap';import{connect}from'react-redux';import{CLIENT_INTERFACE}from'@/plugins/libs/interfaceMap';import{SET_USER_INFO,SET_REDIRECT}from'@/store/actions';import axios from'@/plugins/requestServer/httpClient';import{getStorage}from'@/plugins/common/storage';import Main from'@/views/Main';import Login from'@/views/Login';import{Base64}from'js-base64';var App=/*#__PURE__*/function(_React$Component){_inherits(App,_React$Component);var _super=_createSuper(App);function App(){var _this;_classCallCheck(this,App);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.fetchCheckLogin=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var hash,path,storageUserInfo,res,userData;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:hash=window.location.hash;path=hash.substring(1,hash.length);//用户是否已经登录过了\nif(!_this.props.user.loginFlag){_context.next=5;break;}if(path==='/login'){window.location.hash='#/main/home';}return _context.abrupt(\"return\");case 5://本地是否有存储用户信息\nstorageUserInfo=getStorage('storageUserInfo');//根据本地存储的用户信息，进行请求token是否有效登录，如果有效则更新token值\n_context.prev=6;_context.next=9;return axios.get(CLIENT_INTERFACE.CHECK_IS_LOGIN);case 9:res=_context.sent;if(!(res.data.err!=='0')){_context.next=15;break;}if(!(path==='/login')){_context.next=13;break;}return _context.abrupt(\"return\");case 13:_Toast.info(res.data.msg,1);return _context.abrupt(\"return\");case 15:userData=_objectSpread(_objectSpread({},storageUserInfo),res.data.result);_this.props.setUserInfo(userData);if(path==='/login'){window.location.hash='#/main/home';}console.log('已经登录了');_context.next=24;break;case 21:_context.prev=21;_context.t0=_context[\"catch\"](6);console.log(_context.t0);case 24:case\"end\":return _context.stop();}}},_callee,null,[[6,21]]);}));return _this;}_createClass(App,[{key:\"componentWillMount\",value:function(){var _componentWillMount=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this.fetchCheckLogin();case 2:_context2.next=4;return this.watchToken();case 4:case\"end\":return _context2.stop();}}},_callee2,this);}));function componentWillMount(){return _componentWillMount.apply(this,arguments);}return componentWillMount;}()//是否已经登录过及查证token是否是有效登录，并更新token\n},{key:\"watchToken\",//检测token值的有效，如果在loginFlag=true登录状态的话，则没隔30秒进行检查token有效时间比当前时间是不是小于3分钟，如果小于三分钟则请求刷新token\nvalue:function(){var _watchToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var that,_getStorage,token,jwtTokenArr,tokenExpiration,minTime,res;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!this.props.user.loginFlag){_context5.next=19;break;}window.clearTimeout(this.watchRefreshTime);that=this;_getStorage=getStorage('storageUserInfo'),token=_getStorage.token;if(!(token!=='')){_context5.next=19;break;}jwtTokenArr=token.split('.');tokenExpiration=JSON.parse(Base64.decode(jwtTokenArr[1])).exp;//截取token中的preload中的exp的有效期时间。\nminTime=Math.floor(Date.now()/1000+3*60);//获取当前时间并加上最小的有效期时间\nif(!(tokenExpiration>minTime)){_context5.next=11;break;}//如果大于，则监听30秒之后再检测一次\nthis.watchRefreshTime=setTimeout(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return that.watchToken();case 2:case\"end\":return _context3.stop();}}},_callee3);})),1000*31);return _context5.abrupt(\"return\");case 11:_context5.next=13;return axios.get(CLIENT_INTERFACE.REFRESH_TOKEN);case 13:res=_context5.sent;if(!(res.data.err===\"0\")){_context5.next=19;break;}console.log(\"刷新了token\",res);this.props.setUserInfo({token:res.data.result.token});this.watchRefreshTime=setTimeout(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return that.watchToken();case 2:case\"end\":return _context4.stop();}}},_callee4);})),1000*3);return _context5.abrupt(\"return\");case 19:case\"end\":return _context5.stop();}}},_callee5,this);}));function watchToken(){return _watchToken.apply(this,arguments);}return watchToken;}()},{key:\"render\",value:function render(){var loginFlag=this.props.user.loginFlag;return/*#__PURE__*/React.createElement(Router,null,Routers.map(function(item,index){if(item.path!=='/login'){return/*#__PURE__*/React.createElement(Route,{path:item.path,key:index,exact:true,component:item.loginFlag&&!loginFlag?Login:item.component});}else{return/*#__PURE__*/React.createElement(Route,{path:item.path,key:index,exact:true,component:loginFlag?Main:item.component});}}));}}]);return App;}(React.Component);export default connect(function(state,props){return state;},{setUserInfo:function setUserInfo(data){return{type:SET_USER_INFO,data:data};},setRedirectPath:function setRedirectPath(data){return{type:SET_REDIRECT,data:data};}})(App);","map":null,"metadata":{},"sourceType":"module"}